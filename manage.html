<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Manage Suppliers</title>
  <style>
    :root { --grad1:#667eea; --grad2:#764ba2; --ink:#2d3748; --muted:#4a5568; }
    *{box-sizing:border-box}
    body{font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif;margin:0;padding:20px;background:linear-gradient(135deg,var(--grad1) 0%,var(--grad2) 100%);min-height:100vh}
    .container{max-width:1400px;margin:0 auto;background:rgba(255,255,255,.95);backdrop-filter:blur(10px);border-radius:20px;padding:30px;box-shadow:0 20px 40px rgba(0,0,0,.1)}
    h1{text-align:center;color:var(--ink);margin-bottom:30px;font-size:2.2em;background:linear-gradient(45deg,var(--grad1),var(--grad2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px}
    .muted{color:#6b7280}
    .btn{background:linear-gradient(135deg,var(--grad1),var(--grad2));color:#fff;border:none;padding:12px 18px;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;transition:.3s;display:inline-block;text-decoration:none}
    .btn.alt{background:#e2e8f0;color:#1f2937}
    .btn.danger{background:#dc2626;color:#fff}
    .btn.success{background:#16a34a;color:#fff}
    .btn:hover{transform:translateY(-2px);box-shadow:0 10px 25px rgba(102,126,234,.4)}
    .btn.small{padding:8px 14px;font-size:13px}
    .search-bar{background:#fff;padding:20px;border-radius:15px;margin-bottom:20px;box-shadow:0 10px 25px rgba(0,0,0,.08)}
    .search-bar input{padding:12px 16px;border:2px solid #e2e8f0;border-radius:10px;font-size:16px;width:100%;max-width:400px}
    .search-bar input:focus{outline:none;border-color:var(--grad1);box-shadow:0 0 0 3px rgba(102,126,234,.1)}
    .stats{display:flex;gap:20px;margin-bottom:20px;flex-wrap:wrap}
    .stat-card{background:#fff;padding:20px;border-radius:12px;flex:1;min-width:200px;box-shadow:0 5px 15px rgba(0,0,0,.08)}
    .stat-number{font-size:2em;font-weight:700;color:var(--grad1)}
    .stat-label{color:var(--muted);font-size:.9em;margin-top:5px}
    .table-container{background:#fff;padding:20px;border-radius:15px;box-shadow:0 10px 25px rgba(0,0,0,.08);overflow-x:auto}
    table{width:100%;border-collapse:collapse}
    th{background:linear-gradient(135deg,var(--grad1),var(--grad2));color:#fff;padding:12px;text-align:left;font-weight:600;position:sticky;top:0;z-index:10}
    td{padding:12px;border-bottom:1px solid #e2e8f0}
    tr:hover{background:#f8fafc}
    .service-tag{display:inline-block;background:#e0e7ff;color:#4338ca;padding:4px 10px;border-radius:6px;font-size:.85em;margin:2px}
    .actions-cell{display:flex;gap:8px;flex-wrap:wrap}
    .no-data{text-align:center;padding:40px;color:#718096;font-style:italic}
    
    /* Modal styles */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:9999;align-items:center;justify-content:center}
    .modal.show{display:flex}
    .modal-content{background:#fff;border-radius:15px;padding:30px;max-width:600px;width:90%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .modal-header h2{margin:0;color:var(--ink)}
    .close-btn{background:none;border:none;font-size:28px;cursor:pointer;color:#6b7280;line-height:1}
    .close-btn:hover{color:var(--ink)}
    .form-group{margin-bottom:20px}
    .form-group label{display:block;font-weight:600;margin-bottom:8px;color:#334155}
    .form-group input,.form-group textarea{width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:10px;font-size:15px;font-family:inherit}
    .form-group input:focus,.form-group textarea:focus{outline:none;border-color:var(--grad1);box-shadow:0 0 0 3px rgba(102,126,234,.1)}
    .services-checklist{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;max-height:300px;overflow-y:auto;padding:10px;border:2px solid #e2e8f0;border-radius:10px}
    .service-checkbox{display:flex;align-items:center;gap:8px}
    .service-checkbox input{width:auto;margin:0}
    .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:20px}
    .error-msg{color:#dc2626;font-size:.9em;margin-top:5px}
    .success-msg{background:#d1fae5;color:#065f46;padding:12px;border-radius:8px;margin-bottom:15px;border-left:4px solid #16a34a}
    
    /* Auth overlay */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;justify-content:center;align-items:center;z-index:9999}
    .login-card{width:380px;background:#fff;border-radius:14px;padding:24px;box-shadow:0 20px 60px rgba(0,0,0,.25)}
    .login-card h2{margin:0 0 10px 0}
    .row{display:flex;flex-direction:column;gap:6px;margin:10px 0}
    .row label{font-weight:600;color:#334155}
    input[type=email],input[type=password]{padding:12px 16px;border:2px solid #e2e8f0;border-radius:10px;font-size:16px}
    .error{color:#b91c1c;font-size:.9em;min-height:1.2em}
  </style>
</head>
<body>
  <!-- Auth overlay -->
  <div id="loginOverlay" class="overlay">
    <div class="login-card">
      <h2>Sign in</h2>
      <div class="row">
        <button class="btn" id="btnGoogle">Continue with Google</button>
      </div>
      <div class="row"><div class="muted" style="text-align:center">‚Äî or ‚Äî</div></div>
      <div class="row">
        <label for="loginEmail">Email</label>
        <input id="loginEmail" type="email" autocomplete="username" />
      </div>
      <div class="row">
        <label for="loginPass">Password</label>
        <input id="loginPass" type="password" autocomplete="current-password" />
      </div>
      <div class="actions" style="justify-content:flex-end;margin-top:8px;display:flex;gap:8px">
        <button class="btn" id="btnEmailLogin">Sign in</button>
      </div>
      <div id="loginErr" class="error"></div>
      <div class="muted" style="margin-top:6px">Please contact Tom Edwards if you require an account creating.</div>
    </div>
  </div>

  <div class="container" id="app" style="display:none">
    <div class="topbar">
      <h1>‚öôÔ∏è Manage Suppliers</h1>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <span id="whoami" class="muted"></span>
        <a href="index.html" class="btn alt">‚Üê Back to Search</a>
        <button class="btn alt" id="btnSignOut">Sign out</button>
      </div>
    </div>

    <div id="successMsg" class="success-msg" style="display:none"></div>

    <div class="stats">
      <div class="stat-card">
        <div class="stat-number" id="totalSuppliers">0</div>
        <div class="stat-label">Total Suppliers</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalServices">0</div>
        <div class="stat-label">Unique Services</div>
      </div>
    </div>

    <div class="search-bar">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <input type="text" id="searchInput" placeholder="üîç Search by name, postcode, or service...">
        <button class="btn success" onclick="openAddModal()">‚ûï Add New Supplier</button>
        <button class="btn alt" onclick="exportJSON()">üíæ Export JSON</button>
      </div>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th style="width:25%">Supplier Name</th>
            <th style="width:15%">Postcode</th>
            <th style="width:45%">Services</th>
            <th style="width:15%">Actions</th>
          </tr>
        </thead>
        <tbody id="supplierTable">
          <tr><td colspan="4" class="no-data">Loading suppliers...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Add/Edit Modal -->
  <div id="supplierModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Add New Supplier</h2>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      <form id="supplierForm" onsubmit="return false;">
        <div class="form-group">
          <label for="supplierName">Supplier Name *</label>
          <input type="text" id="supplierName" required>
          <div id="nameError" class="error-msg"></div>
        </div>
        <div class="form-group">
          <label for="supplierPostcode">Postcode *</label>
          <input type="text" id="supplierPostcode" required placeholder="e.g., OL4 2QS or 'Online'">
          <div id="postcodeError" class="error-msg"></div>
        </div>
        <div class="form-group">
          <label>Services</label>
          <div id="servicesChecklist" class="services-checklist">
            <!-- Services will be populated here -->
          </div>
        </div>
        <div class="form-group">
          <label for="newService">Add New Service (optional)</label>
          <input type="text" id="newService" placeholder="Type a new service name">
        </div>
        <div class="modal-actions">
          <button type="button" class="btn alt" onclick="closeModal()">Cancel</button>
          <button type="button" class="btn success" onclick="saveSupplier()">Save Supplier</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="modal">
    <div class="modal-content" style="max-width:400px">
      <div class="modal-header">
        <h2>Confirm Delete</h2>
        <button class="close-btn" onclick="closeDeleteModal()">&times;</button>
      </div>
      <p>Are you sure you want to delete <strong id="deleteSupplierName"></strong>?</p>
      <p style="color:#dc2626;font-size:.9em">This action cannot be undone.</p>
      <div class="modal-actions">
        <button class="btn alt" onclick="closeDeleteModal()">Cancel</button>
        <button class="btn danger" onclick="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>

  <script>
    window.__appBooted = false;
    setTimeout(() => {
      if (!window.__appBooted) {
        const err = document.getElementById('loginErr');
        if (err) err.textContent = 'App failed to start. Check Console for errors.';
        document.getElementById('loginOverlay').style.display = 'flex';
      }
    }, 1500);
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, setPersistence, browserLocalPersistence,
             onAuthStateChanged, signInWithPopup, GoogleAuthProvider,
             signInWithEmailAndPassword, signOut }
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const q = s => document.querySelector(s);
    const loginOverlay = q('#loginOverlay');
    const appRoot = q('#app');
    const loginErr = q('#loginErr');
    const whoami = q('#whoami');

    // Firebase config (same as index.html)
    const firebaseConfig = {
      apiKey: "AIzaSyCjUNXtUu0mIBOq6GK5QnwzLhVj18KcQ9E",
      authDomain: "testauthentication-7b4d5.firebaseapp.com",
      projectId: "testauthentication-7b4d5",
      storageBucket: "testauthentication-7b4d5.firebasestorage.app",
      messagingSenderId: "175852328677",
      appId: "1:175852328677:web:4e7ea0a66400fa477da60c"
    };

    const appFB = initializeApp(firebaseConfig);
    const auth = getAuth(appFB);
    await setPersistence(auth, browserLocalPersistence);

    // Auth handlers
    q('#btnGoogle').addEventListener('click', async () => {
      loginErr.textContent = '';
      try { await signInWithPopup(auth, new GoogleAuthProvider()); }
      catch (e) { loginErr.textContent = e.message; }
    });
    q('#btnEmailLogin').addEventListener('click', async () => {
      loginErr.textContent = '';
      const email = q('#loginEmail').value.trim();
      const pass = q('#loginPass').value;
      try { await signInWithEmailAndPassword(auth, email, pass); }
      catch (e) { loginErr.textContent = e.message; }
    });
    q('#btnSignOut').addEventListener('click', async () => { await signOut(auth); });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        whoami.textContent = user.email || user.displayName || 'User';
        loginOverlay.style.display = 'none';
        appRoot.style.display = 'block';
        window.__appBooted = true;
        startApp();
      } else {
        whoami.textContent = '';
        loginOverlay.style.display = 'flex';
        appRoot.style.display = 'none';
      }
    });

    // Global variables
    let suppliers = [];
    let allServices = new Set();
    let editingIndex = -1;
    let deleteIndex = -1;

    // Utility functions
    function suppliersUrl() {
      const url = new URL(window.location.href);
      url.pathname = url.pathname.replace(/[^/]*$/, 'suppliers.json');
      return url.href + '?v=' + Date.now();
    }

    function normalisePC(pc) {
      if (!pc) return '';
      const cleaned = String(pc).replace(/\u00A0/g,' ').replace(/\s+/g,' ').trim().toUpperCase();
      if (!cleaned || /^ONLINE\b|^EMAIL\b/i.test(cleaned)) return cleaned;
      const t = cleaned.replace(/\s+/g,'');
      if (t.length < 5) return cleaned;
      return t.slice(0, t.length-3) + ' ' + t.slice(-3);
    }

    async function loadSuppliers() {
      try {
        const res = await fetch(suppliersUrl(), { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const raw = await res.json();
        
        suppliers = raw.map(r => ({
          name: r.name ?? r.Supplier ?? r.supplier ?? '',
          postcode: normalisePC(r.postcode ?? r.Postcode ?? r.POSTCODE ?? ''),
          services: Array.isArray(r.services) ? r.services.map(s => String(s).trim()) : []
        })).filter(s => s.name);

        allServices.clear();
        suppliers.forEach(s => s.services.forEach(sv => allServices.add(sv)));
        
        updateStats();
        renderTable();
      } catch (err) {
        console.error('Load error:', err);
        q('#supplierTable').innerHTML = `<tr><td colspan="4" class="no-data">Error loading suppliers: ${err.message}</td></tr>`;
      }
    }

    function updateStats() {
      q('#totalSuppliers').textContent = suppliers.length;
      q('#totalServices').textContent = allServices.size;
    }

    function renderTable(filter = '') {
      const tbody = q('#supplierTable');
      const lowerFilter = filter.toLowerCase();
      
      const filtered = suppliers.filter(s => 
        !filter || 
        s.name.toLowerCase().includes(lowerFilter) ||
        s.postcode.toLowerCase().includes(lowerFilter) ||
        s.services.some(sv => sv.toLowerCase().includes(lowerFilter))
      );

      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="no-data">No suppliers found</td></tr>';
        return;
      }

      tbody.innerHTML = filtered.map((s, idx) => {
        const actualIndex = suppliers.indexOf(s);
        const servicesTags = s.services.map(sv => `<span class="service-tag">${sv}</span>`).join(' ');
        return `
          <tr>
            <td><strong>${s.name}</strong></td>
            <td>${s.postcode || '‚Äî'}</td>
            <td>${servicesTags || '<span class="muted">None</span>'}</td>
            <td>
              <div class="actions-cell">
                <button class="btn small alt" onclick="openEditModal(${actualIndex})">‚úèÔ∏è Edit</button>
                <button class="btn small danger" onclick="openDeleteModal(${actualIndex})">üóëÔ∏è Delete</button>
              </div>
            </td>
          </tr>`;
      }).join('');
    }

    // Search functionality
    q('#searchInput').addEventListener('input', (e) => {
      renderTable(e.target.value);
    });

    // Modal functions
    window.openAddModal = function() {
      editingIndex = -1;
      q('#modalTitle').textContent = 'Add New Supplier';
      q('#supplierName').value = '';
      q('#supplierPostcode').value = '';
      q('#newService').value = '';
      q('#nameError').textContent = '';
      q('#postcodeError').textContent = '';
      populateServicesChecklist();
      q('#supplierModal').classList.add('show');
    };

    window.openEditModal = function(index) {
      editingIndex = index;
      const supplier = suppliers[index];
      q('#modalTitle').textContent = 'Edit Supplier';
      q('#supplierName').value = supplier.name;
      q('#supplierPostcode').value = supplier.postcode;
      q('#newService').value = '';
      q('#nameError').textContent = '';
      q('#postcodeError').textContent = '';
      populateServicesChecklist(supplier.services);
      q('#supplierModal').classList.add('show');
    };

    window.closeModal = function() {
      q('#supplierModal').classList.remove('show');
    };

    function populateServicesChecklist(selectedServices = []) {
      const container = q('#servicesChecklist');
      const sortedServices = [...allServices].sort();
      
      container.innerHTML = sortedServices.map(service => {
        const checked = selectedServices.includes(service) ? 'checked' : '';
        const id = `service-${service.replace(/\s+/g, '-')}`;
        return `
          <div class="service-checkbox">
            <input type="checkbox" id="${id}" value="${service}" ${checked}>
            <label for="${id}">${service}</label>
          </div>`;
      }).join('');
    }

    window.saveSupplier = function() {
      const name = q('#supplierName').value.trim();
      const postcode = q('#supplierPostcode').value.trim();
      const newService = q('#newService').value.trim();
      
      // Validation
      let hasError = false;
      if (!name) {
        q('#nameError').textContent = 'Name is required';
        hasError = true;
      } else {
        q('#nameError').textContent = '';
      }
      
      if (!postcode) {
        q('#postcodeError').textContent = 'Postcode is required';
        hasError = true;
      } else {
        q('#postcodeError').textContent = '';
      }
      
      if (hasError) return;

      // Get selected services
      const selectedServices = Array.from(q('#servicesChecklist').querySelectorAll('input[type="checkbox"]:checked'))
        .map(cb => cb.value);
      
      // Add new service if provided
      if (newService && !selectedServices.includes(newService)) {
        selectedServices.push(newService);
        allServices.add(newService);
      }

      const supplier = {
        name,
        postcode: normalisePC(postcode),
        services: selectedServices
      };

      if (editingIndex >= 0) {
        suppliers[editingIndex] = supplier;
        showSuccess('Supplier updated successfully!');
      } else {
        suppliers.push(supplier);
        showSuccess('Supplier added successfully!');
      }

      // Update services set
      supplier.services.forEach(sv => allServices.add(sv));

      saveToFile();
      updateStats();
      renderTable();
      closeModal();
    };

    // Delete modal functions
    window.openDeleteModal = function(index) {
      deleteIndex = index;
      q('#deleteSupplierName').textContent = suppliers[index].name;
      q('#deleteModal').classList.add('show');
    };

    window.closeDeleteModal = function() {
      q('#deleteModal').classList.remove('show');
      deleteIndex = -1;
    };

    window.confirmDelete = function() {
      if (deleteIndex >= 0) {
        const deleted = suppliers[deleteIndex];
        suppliers.splice(deleteIndex, 1);
        
        // Rebuild services set
        allServices.clear();
        suppliers.forEach(s => s.services.forEach(sv => allServices.add(sv)));
        
        showSuccess(`${deleted.name} deleted successfully!`);
        saveToFile();
        updateStats();
        renderTable();
      }
      closeDeleteModal();
    };

    // Save to file (downloads JSON)
    function saveToFile() {
      const json = JSON.stringify(suppliers, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'suppliers.json';
      a.click();
      URL.revokeObjectURL(url);
      
      console.log('Supplier list updated. Download the new suppliers.json file and upload it to your server.');
    }

    window.exportJSON = function() {
      saveToFile();
      showSuccess('Supplier list exported! Upload the downloaded file to your server.');
    };

    function showSuccess(message) {
      const msg = q('#successMsg');
      msg.textContent = message;
      msg.style.display = 'block';
      setTimeout(() => { msg.style.display = 'none'; }, 5000);
    }

    // Start app
    let appStarted = false;
    async function startApp() {
      if (appStarted) return;
      appStarted = true;
      await loadSuppliers();
    }
  </script>
</body>
</html>
