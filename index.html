<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Supplier Selection System</title>
  <style>
    /* same styles you already had */
    :root { --grad1:#667eea; --grad2:#764ba2; --ink:#2d3748; --muted:#4a5568; }
    *{box-sizing:border-box}
    body{font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif;margin:0;padding:20px;background:linear-gradient(135deg,var(--grad1) 0%,var(--grad2) 100%);min-height:100vh}
    .container{max-width:1200px;margin:0 auto;background:rgba(255,255,255,.95);backdrop-filter:blur(10px);border-radius:20px;padding:30px;box-shadow:0 20px 40px rgba(0,0,0,.1)}
    h1{text-align:center;color:var(--ink);margin-bottom:30px;font-size:2.5em;background:linear-gradient(45deg,var(--grad1),var(--grad2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .input-section{background:#fff;padding:25px;border-radius:15px;margin-bottom:25px;box-shadow:0 10px 25px rgba(0,0,0,.08);border:1px solid rgba(102,126,234,.2)}
    .postcode-input{display:flex;gap:15px;align-items:center;margin-bottom:20px;flex-wrap:wrap}
    input[type=text]{padding:12px 16px;border:2px solid #e2e8f0;border-radius:10px;font-size:16px;transition:.3s;min-width:150px}
    input[type=text]:focus{outline:none;border-color:var(--grad1);box-shadow:0 0 0 3px rgba(102,126,234,.1)}
    .services-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-top:20px}
    .service-item{display:flex;align-items:center;padding:12px;background:#f8fafc;border-radius:8px;transition:.3s;cursor:pointer}
    .service-item:hover{background:#e6fffa;transform:translateY(-2px)}
    .service-item.selected{background:linear-gradient(135deg,var(--grad1),var(--grad2));color:#fff}
    input[type=checkbox]{margin-right:10px;transform:scale(1.2);cursor:pointer}
    .btn{background:linear-gradient(135deg,var(--grad1),var(--grad2));color:#fff;border:none;padding:12px 24px;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;transition:.3s;margin:10px 5px}
    .btn:hover{transform:translateY(-2px);box-shadow:0 10px 25px rgba(102,126,234,.4)}
    .results-section{background:#fff;padding:25px;border-radius:15px;box-shadow:0 10px 25px rgba(0,0,0,.08);border:1px solid rgba(102,126,234,.2)}
    .supplier-card{background:linear-gradient(135deg,#f8fafc 0%,#e2e8f0 100%);border-radius:12px;padding:20px;margin:15px 0;border-left:4px solid var(--grad1);transition:.3s}
    .supplier-card:hover{transform:translateX(5px);box-shadow:0 10px 25px rgba(0,0,0,.1)}
    .supplier-name{font-size:1.3em;font-weight:700;color:var(--ink);margin-bottom:8px}
    .supplier-details{color:var(--muted);font-size:.95em}
    .distance{font-weight:700;color:var(--grad1)}
    .no-results{text-align:center;color:#718096;font-style:italic;padding:40px}
    .loading{text-align:center;padding:20px;color:var(--grad1);animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
  </style>
</head>
<body>
  <div class="container">
    <h1>üéØ Supplier Selection System</h1>

    <div class="input-section">
      <h3>üìç Customer Location & Requirements</h3>
      <div class="postcode-input">
        <label for="postcode"><strong>Customer Postcode:</strong></label>
        <input type="text" id="postcode" placeholder="e.g., NG6 8WA">
        <button class="btn" onclick="findSuppliers()">üîç Find Suppliers</button>
        <button class="btn" onclick="clearAll()">üóëÔ∏è Clear All</button>
      </div>

      <h4>Services Required:</h4>
      <div class="services-grid" id="servicesGrid"></div>
    </div>

    <div class="results-section">
      <h3>üìã Matching Suppliers (Top 3 by Distance)</h3>
      <div id="results">
        <div class="no-results">Select services and click "Find Suppliers" to see results</div>
      </div>
    </div>
  </div>

  <script>
    let suppliers = [];
    const servicesSet = new Set();

    async function loadSuppliers() {
      const res = await fetch('suppliers.json');
      suppliers = await res.json();
      suppliers.forEach(s => s.services.forEach(sv => servicesSet.add(sv)));
    }

    function initializeServices() {
      const grid = document.getElementById('servicesGrid');
      grid.innerHTML = '';
      [...servicesSet].sort().forEach(service => {
        const div = document.createElement('div');
        div.className = 'service-item';
        div.onclick = () => toggleService(div);
        div.innerHTML = `
          <input type="checkbox" id="service-${service}">
          <label for="service-${service}">${service}</label>
        `;
        grid.appendChild(div);
      });
    }

    function toggleService(element) {
      const checkbox = element.querySelector('input[type="checkbox"]');
      checkbox.checked = !checkbox.checked;
      checkbox.checked ? element.classList.add('selected') : element.classList.remove('selected');
    }

    function getSelectedServices() {
      return Array.from(document.querySelectorAll('#servicesGrid input[type="checkbox"]:checked'))
                  .map(cb => cb.id.replace('service-',''));
    }

    // ----- Postcode + Distance functions -----
    const pcCache = new Map(JSON.parse(localStorage.getItem("pcCache") || "[]"));
    const saveCache = () => localStorage.setItem("pcCache", JSON.stringify([...pcCache]));

    function normalisePC(pc) {
      const t = pc.trim().toUpperCase().replace(/\s+/g, '');
      if (t.length < 5) return pc.trim().toUpperCase();
      return t.slice(0, t.length - 3) + ' ' + t.slice(-3);
    }

    async function geocode(postcode) {
      const pc = normalisePC(postcode);
      if (pcCache.has(pc)) return pcCache.get(pc);
      const res = await fetch(`https://api.postcodes.io/postcodes/${encodeURIComponent(pc)}`);
      const data = await res.json();
      if (data.status !== 200 || !data.result) throw new Error("Geocode failed for " + pc);
      const ll = { lat: data.result.latitude, lon: data.result.longitude, pc };
      pcCache.set(pc, ll); saveCache();
      return ll;
    }

    function haversineKm(a, b) {
      const R = 6371, toRad = d => d * Math.PI / 180;
      const dLat = toRad(b.lat - a.lat), dLon = toRad(b.lon - a.lon);
      const la1 = toRad(a.lat), la2 = toRad(b.lat);
      const h = Math.sin(dLat/2)**2 + Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2;
      return 2 * R * Math.atan2(Math.sqrt(h), Math.sqrt(1 - h));
    }

    async function osrmDrivingKm(a, b) {
      const url = `https://router.project-osrm.org/route/v1/driving/${a.lon},${a.lat};${b.lon},${b.lat}?overview=false`;
      const res = await fetch(url);
      const data = await res.json();
      if (!data || data.code !== "Ok" || !data.routes?.length) throw new Error("OSRM failed");
      return data.routes[0].distance / 1000;
    }

    async function bestDistanceKm(fromPc, toPc) {
      const [A, B] = await Promise.all([geocode(fromPc), geocode(toPc)]);
      try { return await osrmDrivingKm(A, B); }
      catch { return haversineKm(A, B); }
    }

    function pLimit(n) {
      let active = 0, q = [];
      const next = () => {
        if (active >= n || q.length === 0) return;
        active++;
        const { fn, resolve, reject } = q.shift();
        fn().then(resolve, reject).finally(() => { active--; next(); });
      };
      return fn => new Promise((resolve, reject) => { q.push({ fn, resolve, reject }); next(); });
    }
    const limit5 = pLimit(5);

    // ----- Main -----
    async function findSuppliers() {
      const customerPostcode = document.getElementById('postcode').value.trim();
      const selectedServices = getSelectedServices();
      const resultsDiv = document.getElementById('results');

      if (!customerPostcode) { resultsDiv.innerHTML = '<div class="no-results">Please enter a customer postcode</div>'; return; }
      if (selectedServices.length === 0) { resultsDiv.innerHTML = '<div class="no-results">Please select at least one service</div>'; return; }

      resultsDiv.innerHTML = '<div class="loading">üîç Calculating driving distances‚Ä¶</div>';

      const matching = suppliers.filter(s =>
        selectedServices.some(sv => s.services.includes(sv))
      );

      if (matching.length === 0) { resultsDiv.innerHTML = '<div class="no-results">No suppliers found for selected services</div>'; return; }

      const enriched = await Promise.all(matching.map(s =>
        limit5(() => bestDistanceKm(customerPostcode, s.postcode)
          .then(km => ({ ...s, distance: km }))
          .catch(() => ({ ...s, distance: Infinity }))
        )
      ));

      const sorted = enriched.sort((a, b) => (a.distance || Infinity) - (b.distance || Infinity))
                             .slice(0, 3); // top 3 only

      let html = `<p><strong>Found ${sorted.length} closest supplier(s) for services: ${selectedServices.join(', ')}</strong></p>`;
      sorted.forEach((s,i) => {
        const distText = isFinite(s.distance) ? `${s.distance.toFixed(1)} km` : 'N/A';
        html += `
          <div class="supplier-card">
            <div class="supplier-name">${i + 1}. ${s.name}</div>
            <div class="supplier-details">
              üìç <strong>Postcode:</strong> ${s.postcode} |
              üìè <strong>Driving distance:</strong> <span class="distance">${distText}</span><br>
              üõ†Ô∏è <strong>Services:</strong> ${s.services.join(', ')}
            </div>
          </div>
        `;
      });

      resultsDiv.innerHTML = html;
    }

    function clearAll() {
      document.getElementById('postcode').value = '';
      document.querySelectorAll('#servicesGrid input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
        cb.parentElement.classList.remove('selected');
      });
      document.getElementById('results').innerHTML = '<div class="no-results">Select services and click "Find Suppliers" to see results</div>';
    }

    window.onload = async () => {
      await loadSuppliers();
      initializeServices();
    };
  </script>
</body>
</html>
