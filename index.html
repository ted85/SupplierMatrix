<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Supplier Selection System</title>
  <style>
    :root { --grad1:#667eea; --grad2:#764ba2; --ink:#2d3748; --muted:#4a5568; }
    *{box-sizing:border-box}
    body{font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif;margin:0;padding:20px;background:linear-gradient(135deg,var(--grad1) 0%,var(--grad2) 100%);min-height:100vh}
    .container{max-width:1200px;margin:0 auto;background:rgba(255,255,255,.95);backdrop-filter:blur(10px);border-radius:20px;padding:30px;box-shadow:0 20px 40px rgba(0,0,0,.1)}
    h1{text-align:center;color:var(--ink);margin-bottom:30px;font-size:2.2em;background:linear-gradient(45deg,var(--grad1),var(--grad2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .input-section{background:#fff;padding:25px;border-radius:15px;margin-bottom:25px;box-shadow:0 10px 25px rgba(0,0,0,.08);border:1px solid rgba(102,126,234,.2)}
    .postcode-input{display:flex;gap:10px;align-items:center;margin-bottom:16px;flex-wrap:wrap}
    input[type=text], input[type=password], input[type=email]{padding:12px 16px;border:2px solid #e2e8f0;border-radius:10px;font-size:16px;transition:.3s;min-width:160px}
    input:focus{outline:none;border-color:var(--grad1);box-shadow:0 0 0 3px rgba(102,126,234,.1)}
    .services-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:10px}
    .service-item{display:flex;align-items:center;padding:10px;background:#f8fafc;border-radius:8px;transition:.3s;cursor:pointer}
    .service-item:hover{background:#e6fffa;transform:translateY(-2px)}
    .service-item.selected{background:linear-gradient(135deg,var(--grad1),var(--grad2));color:#fff}
    input[type=checkbox]{margin-right:10px;transform:scale(1.1);cursor:pointer}
    .btn{background:linear-gradient(135deg,var(--grad1),var(--grad2));color:#fff;border:none;padding:12px 18px;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;transition:.3s}
    .btn.alt{background:#e2e8f0;color:#1f2937}
    .btn:hover{transform:translateY(-2px);box-shadow:0 10px 25px rgba(102,126,234,.4)}
    .results-section{background:#fff;padding:20px;border-radius:15px;box-shadow:0 10px 25px rgba(0,0,0,.08);border:1px solid rgba(102,126,234,.2)}
    .supplier-card{background:linear-gradient(135deg,#f8fafc 0%,#e2e8f0 100%);border-radius:12px;padding:16px;margin:12px 0;border-left:4px solid var(--grad1);transition:.3s}
    .supplier-card:hover{transform:translateX(5px);box-shadow:0 10px 25px rgba(0,0,0,.1)}
    .supplier-name{font-size:1.15em;font-weight:700;color:var(--ink);margin-bottom:6px}
    .supplier-details{color:var(--muted);font-size:.95em}
    .distance{font-weight:700;color:var(--grad1)}
    .no-results{text-align:center;color:#718096;font-style:italic;padding:40px}
    .loading{text-align:center;padding:20px;color:var(--grad1);animation:pulse 2s infinite}
    .debug{margin-top:16px;font-size:.9em;color:#1f2937;background:#eef2ff;border:1px solid #c7d2fe;border-radius:8px;padding:10px}
    .err{color:#b91c1c}
    .actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    .muted{color:#6b7280}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
    /* Login overlay */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;justify-content:center;align-items:center;z-index:9999}
    .login-card{width:380px;background:#fff;border-radius:14px;padding:24px;box-shadow:0 20px 60px rgba(0,0,0,.25)}
    .login-card h2{margin:0 0 10px 0}
    .row{display:flex;flex-direction:column;gap:6px;margin:10px 0}
    .row label{font-weight:600;color:#334155}
    .error{color:#b91c1c;font-size:.9em;min-height:1.2em}
  </style>
</head>
<body>
  <!-- Auth overlay -->
  <div id="loginOverlay" class="overlay" style="display:none">
    <div class="login-card">
      <h2>Sign in</h2>
      <div class="row">
        <button class="btn" id="btnGoogle">Continue with Google</button>
      </div>
      <div class="row"><div class="muted" style="text-align:center">‚Äî or ‚Äî</div></div>
      <div class="row">
        <label for="loginEmail">Email</label>
        <input id="loginEmail" type="email" autocomplete="username" />
      </div>
      <div class="row">
        <label for="loginPass">Password</label>
        <input id="loginPass" type="password" autocomplete="current-password" />
      </div>
      <div class="actions" style="justify-content:flex-end;margin-top:8px">
        <button class="btn" id="btnEmailLogin">Sign in</button>
      </div>
      <div id="loginErr" class="error"></div>
      <div class="muted" style="margin-top:6px">Firebase Authentication. Make sure your GitHub Pages domain is in ‚ÄúAuthorized domains‚Äù.</div>
    </div>
  </div>

  <div class="container" id="app" style="display:none">
    <div class="topbar">
      <h1>üéØ Supplier Selection System</h1>
      <div>
        <span id="whoami" class="muted"></span>
        <button class="btn alt" id="btnSignOut" style="margin-left:8px">Sign out</button>
      </div>
    </div>

    <div class="input-section">
      <h3>üìç Customer Location & Requirements</h3>
      <div class="postcode-input">
        <label for="postcode"><strong>Customer Postcode:</strong></label>
        <input type="text" id="postcode" placeholder="e.g., OL4 2QS">
        <div class="actions">
          <button class="btn" onclick="findSuppliers(false)">üîç Find Top 3</button>
          <button class="btn alt" onclick="findSuppliers(true)">üßæ Show All Matches</button>
          <button class="btn alt" onclick="clearAll()">üóëÔ∏è Clear</button>
        </div>
      </div>

      <h4>Services Required:</h4>
      <div class="services-grid" id="servicesGrid"></div>
      <div id="debug" class="debug" hidden>loading‚Ä¶</div>
    </div>

    <div class="results-section">
      <h3 id="resultsTitle">üìã Matching Suppliers</h3>
      <div id="results">
        <div class="no-results">Select services and click one of the buttons above</div>
      </div>
    </div>
  </div>

  <!-- Firebase v10 modular SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, setPersistence, browserLocalPersistence,
             onAuthStateChanged, signInWithPopup, GoogleAuthProvider,
             signInWithEmailAndPassword, signOut }
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const q = s => document.querySelector(s);
    const loginOverlay = q('#loginOverlay');
    const appRoot = q('#app');
    const loginErr = q('#loginErr');
    const whoami = q('#whoami');

    // ====== PASTE YOUR FIREBASE CONFIG HERE (do NOT delete the variable) ======
    const firebaseConfig = {
      apiKey: "AIzaSyCjUNXtUu0mIBOq6GK5QnwzLhVj18KcQ9E",
      authDomain: "testauthentication-7b4d5.firebaseapp.com"",
      projectId: "testauthentication-7b4d5",
      appId: "1:175852328677:web:4e7ea0a66400fa477da60c",
      // storageBucket, messagingSenderId are optional for Auth-only
    };
    // ========================================================================

    // Optional allow-list (uncomment to enforce)
    // const ALLOWED_EMAILS = ["you@yourcompany.com"];
    // const ALLOWED_DOMAINS = ["yourcompany.com"];
    // function emailAllowed(email) {
    //   if (!email) return false;
    //   const domain = email.split("@")[1]?.toLowerCase();
    //   return ALLOWED_EMAILS.includes(email.toLowerCase()) ||
    //          ALLOWED_DOMAINS.includes(domain);
    // }

    let auth;
    try {
      // Guard: if config was left blank, throw a friendly error
      if (!firebaseConfig || !firebaseConfig.apiKey) {
        throw new Error("Firebase config missing. Paste your firebaseConfig in the HTML.");
      }

      const appFB = initializeApp(firebaseConfig);
      auth = getAuth(appFB);
      setPersistence(auth, browserLocalPersistence);

      // Sign-in handlers
      q('#btnGoogle').addEventListener('click', async () => {
        loginErr.textContent = '';
        try { await signInWithPopup(auth, new GoogleAuthProvider()); }
        catch (e) { loginErr.textContent = e.message; }
      });
      q('#btnEmailLogin').addEventListener('click', async () => {
        loginErr.textContent = '';
        const email = q('#loginEmail').value.trim();
        const pass = q('#loginPass').value;
        try { await signInWithEmailAndPassword(auth, email, pass); }
        catch (e) { loginErr.textContent = e.message; }
      });
      q('#btnSignOut').addEventListener('click', async () => { await signOut(auth); });

      // Auth gate
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          // if (ALLOWED_EMAILS.length || ALLOWED_DOMAINS.length) {
          //   if (!emailAllowed(user.email)) {
          //     await signOut(auth);
          //     loginErr.textContent = "Your account isn‚Äôt approved for access.";
          //     loginOverlay.style.display = 'flex';
          //     appRoot.style.display = 'none';
          //     return;
          //   }
          // }
          whoami.textContent = user.email || user.displayName || '(signed in)';
          loginOverlay.style.display = 'none';
          appRoot.style.display = 'block';
          startApp(); // defined in the app script
        } else {
          appRoot.style.display = 'none';
          loginOverlay.style.display = 'flex';
          loginErr.textContent = '';
        }
      });
    } catch (e) {
      // If Firebase init fails, show overlay with an error message
      console.error(e);
      appRoot.style.display = 'none';
      loginOverlay.style.display = 'flex';
      loginErr.textContent = e.message || String(e);
    }
  </script>

  <!-- App logic -->
  <script>
    // Show any runtime JS errors in-page
    window.addEventListener('error', (e) => {
      const dbg = document.getElementById('debug');
      if (!dbg) return;
      dbg.hidden = false;
      dbg.innerHTML = `<span class="err">JS error: ${e.message}</span>`;
    });

    let suppliers = [];
    const servicesSet = new Set();
    let lastComputed = [];

    function suppliersUrl() {
      const u = new URL('suppliers.json', window.location.href);
      u.searchParams.set('v', Date.now().toString());
      return u.toString();
    }

    function normalisePC(pc) {
      if (!pc) return '';
      const cleaned = String(pc).replace(/\u00A0/g,' ').replace(/\s+/g,' ').trim().toUpperCase();
      if (!cleaned || /^ONLINE\b|^EMAIL\b/i.test(cleaned)) return '';
      const t = cleaned.replace(/\s+/g,'');
      if (t.length < 5) return cleaned;
      return t.slice(0, t.length-3) + ' ' + t.slice(-3);
    }

    async function loadSuppliers() {
      const dbg = document.getElementById('debug');
      dbg.hidden = false; dbg.textContent = 'Fetching suppliers.json‚Ä¶';
      const res = await fetch(suppliersUrl(), { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status} fetching suppliers.json`);
      const raw = await res.json();

      suppliers = raw.map(r => {
        const name = r.name ?? r.Supplier ?? r.supplier ?? '';
        const pc = normalisePC(r.postcode ?? r.Postcode ?? r.POSTCODE ?? '');
        const svcs = Array.isArray(r.services) ? r.services.map(s => String(s).trim()) : [];
        return { name, postcode: pc, services: svcs };
      }).filter(s => s.name);

      suppliers.forEach(s => s.services.forEach(sv => servicesSet.add(sv)));
      dbg.textContent = `Dataset loaded: ${suppliers.length} suppliers, ${servicesSet.size} services.`;
    }

    function initializeServices() {
      const grid = document.getElementById('servicesGrid');
      grid.innerHTML = '';
      [...servicesSet].sort().forEach(service => {
        const div = document.createElement('div');
        div.className = 'service-item';
        div.onclick = () => {
          const cb = div.querySelector('input');
          cb.checked = !cb.checked;
          div.classList.toggle('selected', cb.checked);
        };
        div.innerHTML = `<input type="checkbox" id="service-${service}"><label for="service-${service}">${service}</label>`;
        grid.appendChild(div);
      });
    }

    function getSelectedServices() {
      return Array.from(document.querySelectorAll('#servicesGrid input[type="checkbox"]:checked'))
        .map(cb => cb.id.replace('service-',''));
    }

    const pcCache = new Map(JSON.parse(localStorage.getItem("pcCache") || "[]"));
    const saveCache = () => localStorage.setItem("pcCache", JSON.stringify([...pcCache]));

    async function geocode(postcode) {
      const pc = normalisePC(postcode);
      if (!pc) throw new Error("Blank/online postcode");
      if (pcCache.has(pc)) return pcCache.get(pc);
      const res = await fetch(`https://api.postcodes.io/postcodes/${encodeURIComponent(pc)}`);
      const data = await res.json();
      if (data.status !== 200 || !data.result) throw new Error("Geocode failed for " + pc);
      const ll = { lat: data.result.latitude, lon: data.result.longitude, pc };
      pcCache.set(pc, ll); saveCache();
      return ll;
    }

    function haversineKm(a, b) {
      const R = 6371, toRad = d => d * Math.PI / 180;
      const dLat = toRad(b.lat - a.lat), dLon = toRad(b.lon - a.lon);
      const la1 = toRad(a.lat), la2 = toRad(b.lat);
      const h = Math.sin(dLat/2)**2 + Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2;
      return 2 * R * Math.atan2(Math.sqrt(Math.sqrt ? Math.sin(dLat/2)**2 + Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2 : 0), Math.sqrt(1 - (Math.sin(dLat/2)**2 + Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2)));
    }
    // small fix: simpler haversine (avoid inline sqrt bug if copied)
    function haversineKm(a,b){
      const R=6371,toRad=d=>d*Math.PI/180;
      const dLat=toRad(b.lat-a.lat), dLon=toRad(b.lon-a.lon);
      const la1=toRad(a.lat), la2=toRad(b.lat);
      const h=Math.sin(dLat/2)**2+Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2;
      return 2*R*Math.atan2(Math.sqrt(h),Math.sqrt(1-h));
    }

    async function osrmDrivingKm(a, b) {
      const url = `https://router.project-osrm.org/route/v1/driving/${a.lon},${a.lat};${b.lon},${b.lat}?overview=false`;
      const res = await fetch(url);
      const data = await res.json();
      if (!data || data.code !== "Ok" || !data.routes?.length) throw new Error("OSRM failed");
      return data.routes[0].distance / 1000;
    }

    async function bestDistanceKm(fromPc, toPc) {
      const [A, B] = await Promise.all([geocode(fromPc), geocode(toPc)]);
      try { return await osrmDrivingKm(A, B); }
      catch { return haversineKm(A, B); }
    }

    function renderResults(items, title) {
      const resultsDiv = document.getElementById('results');
      document.getElementById('resultsTitle').textContent = title;
      if (!items.length) {
        resultsDiv.innerHTML = '<div class="no-results">No matching suppliers</div>';
        return;
      }
      let html = '';
      items.forEach((s, i) => {
        const distText = (s.distance !== null && s.distance !== undefined)
          ? `${s.distance.toFixed(1)} km`
          : `N/A${s._err ? ` <em>(distance lookup issue: ${s._err})</em>` : ''}`;
        html += `
          <div class="supplier-card">
            <div class="supplier-name">${i + 1}. ${s.name}</div>
            <div class="supplier-details">
              üìç <strong>Postcode:</strong> ${s.postcode || '‚Äî'} |
              üìè <strong>Driving distance:</strong> <span class="distance">${distText}</span><br>
              üõ†Ô∏è <strong>Services:</strong> ${s.services.join(', ')}
            </div>
          </div>`;
      });
      resultsDiv.innerHTML = html;
    }

    async function findSuppliers(showAll) {
      const rawPC = document.getElementById('postcode').value.trim();
      const customerPostcode = normalisePC(rawPC);
      const selectedServices = getSelectedServices();
      const dbg = document.getElementById('debug');
      const resultsDiv = document.getElementById('results');

      if (!rawPC) { resultsDiv.innerHTML = '<div class="no-results">Please enter a customer postcode</div>'; return; }
      if (selectedServices.length === 0) { resultsDiv.innerHTML = '<div class="no-results">Please select at least one service</div>'; return; }

      resultsDiv.innerHTML = '<div class="loading">üîç Calculating driving distances‚Ä¶</div>';

      const matching = suppliers.filter(s => selectedServices.some(sv => s.services.includes(sv)));
      if (matching.length === 0) { resultsDiv.innerHTML = `<div class="no-results">No suppliers found for: ${selectedServices.join(', ')}</div>`; return; }

      const enriched = await Promise.all(matching.map(async s => {
        try { const km = await bestDistanceKm(customerPostcode, s.postcode); return { ...s, distance: km, _err: null }; }
        catch (err) { return { ...s, distance: null, _err: err?.message || 'distance failed' }; }
      }));

      lastComputed = enriched.sort((a, b) => {
        if (a.distance === null && b.distance !== null) return 1;
        if (a.distance !== null && b.distance === null) return -1;
        if (a.distance === null && b.distance === null) return 0;
        return a.distance - b.distance;
      });

      dbg.hidden = false;
      dbg.innerHTML = `<strong>Debug:</strong> Postcode: <code>${customerPostcode}</code> ‚Ä¢ Services: ${selectedServices.join(', ')} ‚Ä¢ Matches: ${lastComputed.length}`;

      const list = showAll ? lastComputed : lastComputed.slice(0, 3);
      renderResults(list, showAll ? 'üìã All Matching Suppliers' : 'üìã Top 3 by Distance');
    }

    function clearAll() {
      document.getElementById('postcode').value = '';
      document.querySelectorAll('#servicesGrid input[type="checkbox"]').forEach(cb => { cb.checked = false; cb.parentElement.classList.remove('selected'); });
      document.getElementById('results').innerHTML = '<div class="no-results">Select services and click one of the buttons above</div>';
    }

    // Start after auth
    let appStarted = false;
    async function startApp() {
      if (appStarted) return; // idempotent
      appStarted = true;
      await loadSuppliers();
      initializeServices();
    }
  </script>
</body>
</html>
